### 230925

#### SQL JOIN


use sqldb4; -- set as default schema (sqldb4) 와 같음

-- 3개 테이블 결합 : 조인 조건 2ro

-- 고객별로 총주문수량 계산하여
-- 고객명과 총주문수량 출력
-- 총주문수량 기준 내림차순 정렬
-- 고객번호, 고객명, 총주문수량
select c.clientno as 고객번호, c.clientname as 고객명, sum(bs.bsqty) as 총주문수량 -- primary key인 고객번호로 그루핑해서 출력하기 때문에 distinct 불필요
from client as c
	inner join booksale bs on c.clientno = bs.clientno
--     inner join book b on b.bookno = bs.bookno -- 도서와 관련된 것은 없기 때문에 join book 은 필요없음
group by c.clientno
order by 총주문수량 desc;
    
-- join 연습문제
-- 1. 모든 도서에 대하여 도서의 도서번호, 도서명, 출판사명 출력
select b.bookno as 도서번호, b.bookname as 도서명, pb.pubname as 출판사명
from book b
	inner join publisher as pb on b.pubno = pb.pubno;
    
-- 2. '서울 출판사'에서 출간한 도서의 도서명, 저자명, 출판사명 출력 (조건에 출판사명 사용)
select b.bookname as 도서명, b.bookauthor as 저자명, pb.pubname as 출판사명
from book b
    inner join publisher pb on b.pubno = pb.pubno
    inner join booksale bs on b.bookno = bs.bookno
where pb.pubname = '서울 출판사';

-- 3. '정보출판사'에서 출간한 도서 중 판매된 도서의 도서명 출력 (중복된 경우 한 번만 출력) (조건에 출판사명 사용)
select distinct b.bookname as 도서명, pb.pubname as 출판사명
from book b
    inner join publisher pb on b.pubno = pb.pubno
    inner join booksale bs on b.bookno = bs.bookno
where pb.pubname = '정보출판사';

-- 4. 도서가격이 30,000원 이상인 도서를 주문한 고객의 고객명, 도서명, 도서가격, 주문수량 출력
select c.clientname as 고객명, b.bookname as 도서명, b.bookprice as 도서가격, bs.bsqty as 주문수량
from booksale bs
	inner join client c on c.clientno = bs.clientno
    inner join book b on b.bookno = bs.bookno
where b.bookprice >= 30000;

-- 5. '안드로이드 프로그래밍' 도서를 구매한 고객에 대하여 도서명, 고객명, 성별, 주소 출력 (고객명으로 오름차순 정렬)
select b.bookname as 도서명, c.clientname as 고객명, c.clientgender as 성별, c.clientaddress as 주소
from booksale bs
    inner join book b on b.bookno = bs.bookno
	inner join client c on c.clientno = bs.clientno
where b.bookname = '안드로이드 프로그래밍'
order by 고객명;

-- 6. ‘도서출판 강남'에서 출간된 도서 중 판매된 도서에 대하여 ‘총 매출액’ 출력
select sum(b.bookprice*bs.bsqty) as '총 매출액' 
from book b
	inner join publisher pb on pb.pubno = b.pubno
    inner join booksale bs on bs.bookno = b.bookno
where pb.pubname = '도서출판 강남';

-- 7. ‘서울 출판사'에서 출간된 도서에 대하여 판매일, 출판사명, 도서명, 도서가격, 주문수량, 주문액 출력
select bs.bsdate as 판매일, pb.pubname as 출판사명, b.bookname as 도서명, b.bookprice as 도서가격, bs.bsqty as 주문수량, b.bookprice*bs.bsqty as 주문액
from book b
	inner join booksale bs on bs.bookno = b.bookno
	inner join publisher pb on pb.pubno = b.pubno
where pb.pubname = '서울 출판사';

-- 8. 판매된 도서에 대하여 도서별로 도서번호, 도서명, 총 주문 수량 출력
select b.bookno, b.bookname as 도서명, sum(bs.bsqty) as 총주문수량
from booksale bs
    inner join book b on b.bookno = bs.bookno
group by b.bookno;

-- 9. 판매된 도서에 대하여 고객별로 고객명, 총구매액 출력 ( 총구매액이 100,000원 이상인 경우만 해당)
select c.clientname as 고객명, sum(b.bookprice*bs.bsqty) as 총구매액
from booksale bs
	inner join client c on c.clientno = bs.clientno
    inner join book b on b.bookno = bs.bookno
where b.bookprice*bs.bsqty >= 100000
group by c.clientno;

-- 10. 판매된 도서 중 ＇도서출판 강남'에서 출간한 도서에 대하여 고객명, 주문일, 도서명, 주문수량, 출판사명 출력 (고객명으로 오름차순 정렬)
select c.clientname as 고객명, bs.bsdate as 주문일, b.bookname as 도서명, bs.bsqty as 주문수량, pb.pubname as 출판사명
from booksale bs 
		inner join client c on c.clientno = bs.clientno 
		inner join book b on b.bookno = bs.bookno
		inner join publisher pb on pb.pubno = b.pubno
where pb.pubname = '도서출판 강남'
order by 고객명;

-- 외부 조인 (outer join)
-- 공통된 속성을 매개로 하는 정보가 없더라도
-- 데이터를 버리지 않고 연산의 결과를 테이블에 표시
-- 좌측 외부조인 / 우측 외부조인 / 완전 외부조인

-- 왼쪽 (client) 기준
-- client 테이블의 데이터 모두 출력
-- 오른쪽 booksale 테이블 : client 테이블에는 존재하지만 booksale 테이블에는 존재하지 않는 고객에 대해서는 null 값으로 출력
-- null 의 의미 : 고객 중 한 번도 구매한 적이 없는 고객에 해당
select * 
from client c
	left outer join booksale bs on c.clientno = bs.clientno
order by c.clientno;

-- null 의 의미 : 고객 중 한 번도 구매한 적이 없는 고객에 해당
select c.clientno, c.clientname
from client c
	left outer join booksale bs on c.clientno = bs.clientno
where bs.clientno is null
order by c.clientno;

-- 도서 중에서 한번도 판매된 적이 없는 도서 출력
select b.bookno, b.bookname
from book b
	left outer join booksale bs on b.bookno = bs.bookno
where bs.bookno is null
order by b.bookno;

-- 오른쪽 테이블 (booksale) 기준
-- booksale 테이블의 데이터 모두 출력
-- 이 때 client 테이블에는 한번이라도 주문한 적이 있는 고객 정보만 출력

select *
from client c
	right outer join booksale bs on c.clientno = bs.clientno
order by c.clientno;

-- 완전 

select *
from client c
	left join booksale bs on c.clientno = bs.clientno

union

select *
from client c
	right join booksale bs on c.clientno = bs.clientno;

-- 서브쿼리

-- 단일행 서브쿼리 (=)

-- 고객명 호날두의 주문수량 조회
-- (1) 서브 쿼리 : client 테이블에서 고객명으로 검색해서 clientno 찾음
-- (2) 메인 쿼리 : booksale 테이블에서 찾은 client에 해당되는 정보를 출력
-- 주문일, 주문수량 출력
select bsdate, bsqty
from booksale
where clientno = (select clientno
				  from client
				  where clientname = '호날두');

-- 고객명 호날두의 주문수량 조회
-- (1) 서브 쿼리 : client 테이블에서 고객명으로 검색해서 clientno 찾음
-- (2) 메인 쿼리 : booksale 테이블에서 찾은 clientno에 해당되는 총주문수량 계산
select sum(bsqty) as 총주문수량
from booksale
where clientno = (select clientno
				  from client
				  where clientname = '호날두');

-- 가장 비싼 도서의 도서명과 가격 출력
-- (1) max() 도서 찾아서
-- (2) 해당 도서의 도서명과 가격 출력
select bookname, bookprice
from book
where bookprice = (select max(bookprice)
				  from book);

-- 단일행 비교연산자                  
-- 도서의 평균가격보다 가격이 큰 모든 도서 출력
-- (1) 평균가격보다 큰 도서의 가격
select bookname, bookprice
from book
where bookprice > (select avg(bookprice) from book);

select avg(bookprice) as 평균도서가격 from book;

-- 다중 행 서브쿼리 (in / not in)
-- 단일 행 ㅂ2ㅏㄴ환 시에 사용해도 됨
-- 서브쿼리 결과가 단일행인지 다중행인지 모를 경우 in 사용하면 됨
-- 도서를 구매한 적이 있는 고객의 고객명 출력
-- (1) booksale에 있는 clientno 는 모두 구매한 고객

 -- 여러행 반환
select clientno, clientname
from client
where clientno in (select clientno from booksale);

-- 한번도 주문한 적이 없는 고객의 고객번호, 고객명 출력
select clientno, clientname
from client
where clientno not in (select clientno from booksale);

-- 고객명이 '안드로이드 프로그래밍'인 도서를 구매한 고객의 고객명을 출력
-- 고객번호와 고객명 출력
select clientno, clientname
from client
where clientno in (select clientno from booksale where bookno = (select bookno from book where bookname = '안드로이드 프로그래밍'));

-- '안드로이드' 관련 도서를 구매한 고객의 고객명을 출력
-- 고객번호와 고객명 출력
select clientno, clientname
from client
where clientno 
in (select clientno from booksale where bookno 
		in (select bookno from book where bookname like '%안드로이드%'))
order by clientname; -- 정렬 추가

-- 다중 행 서브쿼리 (exists / not exists)
-- exists : 서브쿼리 결과가 행을 반환하면 참이 되는 연산자
-- 도서를 구매한 적이 있는 고객
-- (1) booksale 테이블에서 조건에 해당되는 행이 존재하면 참 반환
-- (2) client 테이블에서 이 clientno에 해당되는 고객의 
-- 고객번호, 고객명 출력

select clientno, clientname
from client c
where exists (select clientno from booksale bs where c.clientno = bs.clientno);

-- 한 번도 주문한 적이 없는 고객의 고객번호, 고객명 출력
-- 서브쿼리에서 조건에 해당되는 행이 없으면 true를 반환
select clientno, clientname
from client
where not exists (select clientno from booksale where client.clientno = booksale.clientno);

-- null 인 경우 in과 exists 차이
-- null 값을 포함한 clienthobby 확인

select clienthobby from client;

-- exists : 서브쿼리 결과에 null 값 포함
select clienthobby from client
where exists (select clienthobby from booksale);
		
-- in : 서브쿼리 결과에 null 값 포함되지 않음
select clienthobby from client
where clienthobby in (select clienthobby from booksale);   
        
        
	




    

    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    










