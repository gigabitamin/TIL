## 250711  
- 다른 서버(render 등)에 올릴 mount 용 로컬 doker image 생성(light 버전 360MB, slim(분할 버전) 640MB, normal 1.6GB)
- 아바타 ON/OFF 모드 추가
- 문제 : 아바타/카메라 ON/OFF 조합 변경 시 컴포넌트가 언마운트→마운트되어 이미 렌더링(로드)된 아바타가 다시 로드되는 현상 -> 불필요한 네트워크/리소스 낭비 (Railway 서버 5$ 플랜 고려) 및 사용자 경험 저하 
- 원인 : 분기 구조가 조건부 렌더링({isAiAvatarOn && ...} 등)으로 되어 있어, 화면 분할 상태가 바뀔 때마다 해당 컴포넌트가 DOM에서 완전히 사라졌다가 다시 나타남 (React는 key/위치가 바뀌면 새로 마운트)
- 해결 방향 : 항상 컴포넌트는 마운트된 상태로 두고, 화면 분할/위치/크기/가시성만 동적으로 조절  
- avatar-container 내부에 AI 아바타, 사용자 아바타, 카메라 컴포넌트를 항상 렌더링
- 각 컴포넌트의 style을 상태 조합에 따라 동적으로 조정, 분할/오버레이/숨김 등은 style로만 처리
- React의 key 속성을 잘못 주면 새로 마운트되니, key를 고정하거나 아예 주지 않음


### mysql db emoji 저장 error -> utf8mb4 강제 적용으로 해결

- 로컬에서 문제없이 구동되던 AI API 응답이 서버 배포 버전으로 패키지 구조 변경 후 emoji 저장 에러가 뜨기 시작
- <원인>
- 1. Django 데이터베이스 설정 방식의 변화 : 
- 이전(로컬 개발) settings.py에서 직접 ENGINE, OPTIONS, charset, init_command 등을 명시적으로 설정.  
이 경우 Django가 MySQL에 연결할 때 utf8mb4가 잘 적용되어 이모지 저장에 문제가 없었음.  
이후(서버 배포/구조 변경) dj_database_url을 사용해 DATABASE_URL 환경변수로 DB설정을 읽어오고, 서버/로컬을 모두 같은 방식으로 처리하려고 구조를 바꾼 뒤에는 OPTIONS, charset, init_command 등이 누락되거나, MySQL 클라이언트/커넥션 문자셋이 기본값(euckr 등)으로 돌아가 이모지 저장이 깨지기 시작.  
- 2. MySQL 서버/클라이언트 문자셋 설정 불일치
- 로컬 개발 환경에서는 my.ini, 테이블, Django 설정이 모두 utf8mb4로 맞춰져 있지만, 서버 환경에서는 my.ini가 제대로 적용되지 않거나 Docker, Railway, Cloud DB 등에서 서버 설정이 강제되거나 Django가 커넥션마다 utf8mb4를 강제하지 않으면
클라이언트/커넥션 문자셋이 euckr, latin1 등으로 남아 이모지 저장이 실패
- 3. Django 버전 및 커스텀 백엔드 구조 변화
- Django 5.x에서는 DB 커넥션 옵션 처리 방식이 바뀌었고, 기존 방식(예: self.options 사용)이 더 이상 동작하지 않아 구조 변경(커스텀 백엔드 도입, settings.py 구조화 등) 과정에서 옵션이 누락되거나, 적용 위치가 잘못되어 문제가 발생할 수 있음.  
- 4. 환경 변수 및 배포 자동화의 영향
- 서버 배포 시 환경 변수(DATABASE_URL 등)만으로 DB 연결을 처리하면 문자셋 옵션이 빠지기 쉽고, 배포 자동화(Docker, Railway 등) 환경에서는 my.ini가 무시되거나, DB 서버 자체가 utf8mb4로 세팅되어 있지 않을 수도 있음. 
- <정리>
- 로컬 개발: 직접 옵션을 명시하거나, 환경이 잘 맞춰져 있어서 문제 없음
- 서버/구조 변경: 환경 변수 기반 설정, 옵션 누락, Django/MySQL 버전 차이, 서버/클라이언트 문자셋 불일치 등이 겹치면서 이모지 저장 문제가 발생. 
- 이번에 적용한 커스텀 백엔드 Django가 어떤 방식으로 DB에 연결하든, 항상 utf8mb4 문자셋과 collation을 강제 적용하도록 만들었기 때문에 앞으로는 환경/배포 방식에 상관없이 이모지 저장 가능.    


# React 채팅창 마크다운, LaTeX, 차트(Chart.js) 표시 워크플로우 정리

## 1. 문제 상황 및 요구사항
- 채팅창에서 다양한 메시지(마크다운, LaTeX 수식, 코드, JSON, 차트 등)를 자연스럽게 출력하고 싶음
- Chart.js/react-chartjs-2 기반 차트가 JSON 데이터로 입력될 때 자동으로 차트로 변환되어 표시되길 원함
- 코드블록, 수식, 차트, 일반 텍스트 등 다양한 메시지 유형을 구분하여 각기 다른 스타일/기능 적용 필요

## 2. 주요 개선 및 구현 내용

### 2.1 마크다운/수식/코드/차트 파싱 구조 개선
- `parseMessageBlocks(text)` 함수에서
    - $$...$$ → LaTeX 블록 수식
    - ```json ... ``` → 차트 데이터(JSON)
    - ```js ... ``` 등 → 코드블록
    - 나머지 → 마크다운 텍스트
- 각 블록 타입별로 분기하여 렌더링

### 2.2 LaTeX 수식 표시
- remark-math, rehype-katex, katex 라이브러리 활용
- 블록 수식($$...$$)은 KaTeX로 렌더링

### 2.3 코드/JSON/차트 카드 컴포넌트
- 코드블록/JSON/차트는 카드 스타일(`.code-json-card`)로 감싸서 출력
- 코드블록은 Prism.js로 하이라이트, Copy 버튼 제공
- JSON이 차트로 변환 가능한 구조면 차트 토글 버튼(📊/코드) 제공
- 차트 이미지를 클릭하면 모달로 크게 확대해서 볼 수 있음

### 2.4 차트 색상/스타일 개선
- 데이터셋 수와 상관없이 밝은 색상(borderColor, backgroundColor 등)을 순환 적용
- 축/범례/레이블/그리드 등도 밝은 색으로 지정하여 어두운 카드 배경에서도 선명하게 표시

### 2.5 차트 확대 모달 기능
- 차트 이미지를 클릭하면 모달 창으로 크게 확대해서 볼 수 있도록 구현
- 이미지 뷰어와 유사한 UX 제공

## 3. 최종 요약
- 마크다운, LaTeX, 코드, JSON, 차트 등 다양한 메시지 유형을 자동으로 구분/파싱하여 각기 다른 스타일과 기능으로 출력
- 차트는 JSON 데이터만 입력해도 자동 변환, 밝은 색상/굵기/포인트로 시각화, 클릭 시 모달로 확대 가능
- 코드/JSON/차트는 카드 스타일+복사/토글/확대 기능 제공
- 전체 구조는 데이터 수/종류 변화에도 유연하게 동작하도록 설계

---
